# Description: Open CASCADE Technology, 3D modeling & numerical simulation
# URL: http://www.opencascade.org
# Packager: milisarge
# Depends on: xorg-mesa

pkgname=opencascade
pkgver=7.0.0
pkgrel=4

source=(https://freefr.dl.sourceforge.net/project/spacenav/spacenav%20daemon/spacenavd%20$version/$name-$version.tar.gz
		Makefile.patch)

build() {
	cd opencascade-${pkgver}

	mkdir -p build
	cd build
	flags=""
	flags="$flags -DCMAKE_BUILD_TYPE=Release"
	#flags="$flags -D3RDPARTY_VTK_DIR=/opt/vtk6"
	#flags="$flags -D3RDPARTY_VTK_INCLUDE_DIR=/opt/vtk6/include"
	#flags="$flags -D3RDPARTY_VTK_LIBRARY_DIR=/opt/vtk6/lib"
	#flags="$flags -D3RDPARTY_VTK_BIN_DIR=/opt/vtk6/bin"
	flags="$flags -DCMAKE_INSTALL_PREFIX=/opt/${pkgname}"
	flags="$flags -DUSE_GL2PS=ON"
	flags="$flags -D3RDPARTY_GL2PS_DIR="
	flags="$flags -DUSE_FREEIMAGE=ON"
	flags="$flags -DUSE_TBB=ON"
	flags="$flags -DUSE_VTK=ON"
	#flags="$flags -DBUILD_LIBRARY_TYPE=Static"
	#flags="$flags -DBUILD_YACCLEX=ON"
	#flags="$flags -D3RDPARTY_BISON_EXECUTABLE=bison"
	#flags="$flags -D3RDPARTY_FLEX_EXECUTABLE=flex"
	if pacman -T intel-tbb > /dev/null 2>/dev/null; then
	flags="$flags -DUSE_TBB=ON"
	else
	flags="$flags -DUSE_TBB=OFF"
	fi
	#flags="$flags -DUSE_TBB=OFF"
	cmake $flags ..

	# this allows USE_VTK=ON to build
	sed -i 's/-lvtkRenderingOpenGL/-lvtkRenderingOpenGL2/g' src/TKIVtk/CMakeFiles/TKIVtk.dir/link.txt
	sed -i 's/-lvtkRenderingOpenGL/-lvtkRenderingOpenGL2/g' src/TKIVtkDraw/CMakeFiles/TKIVtkDraw.dir/link.txt
	sed -i 's/-lvtkRenderingFreeTypeOpenGL/-lvtkRenderingFreeTypeTCL/g' src/TKIVtk/CMakeFiles/TKIVtk.dir/link.txt
	sed -i 's/-lvtkRenderingFreeTypeOpenGL/-lvtkRenderingFreeTypeTCL/g' src/TKIVtkDraw/CMakeFiles/TKIVtkDraw.dir/link.txt

	cd opencascade-${pkgver}/build
	make
	make DESTDIR="${pkgdir}" install
	install -Dm644 ../LICENSE_LGPL_21.txt -t "$pkgdir/usr/share/licenses/$pkgname/"
	install -Dm644 ../OCCT_LGPL_EXCEPTION.txt -t "$pkgdir/usr/share/licenses/$pkgname/"
}
